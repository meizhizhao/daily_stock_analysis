name: intraday-5m-monitor

on:
  workflow_dispatch: {}

  # GitHub cron = UTC
  # 北京时间(UTC+8) A股：09:30-11:30 / 13:00-15:00
  # 对应 UTC：01:30-03:30 / 05:00-07:00
  schedule:
    # 01:30-01:59 UTC：用固定分钟列表（避免 "*/5 30-59" 组合非法）
    - cron: "30,35,40,45,50,55 1 * * 1-5"

    # 02:00-03:59 UTC：每5分钟
    - cron: "*/5 2-3 * * 1-5"

    # 05:00-06:59 UTC：每5分钟
    - cron: "*/5 5-6 * * 1-5"

    # 07:00 UTC：跑一次（覆盖到北京时间 15:00）
    - cron: "0 7 * * 1-5"

permissions:
  contents: read

concurrency:
  group: intraday-5m-monitor
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Ensure state file exists
        run: |
          if [ ! -f intraday_state.json ]; then echo "{}" > intraday_state.json; fi
          ls -la

      # 缓存状态文件（让 cooldown / ORB 在不同 run 之间延续）
      - name: Cache intraday state
        uses: actions/cache@v4
        with:
          path: intraday_state.json
          key: intraday-state-${{ github.repository }}-${{ github.ref_name }}
          restore-keys: |
            intraday-state-${{ github.repository }}-

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install -U akshare pandas requests pytz python-dateutil

      - name: Run intraday watcher
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          SYM_LLM_COOLDOWN_MIN: ${{ secrets.SYM_LLM_COOLDOWN_MIN }}

          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}

          STOCK_LIST: ${{ secrets.STOCK_LIST }}
          INDEX_LIST: ${{ secrets.INDEX_LIST }}
          COOLDOWN_MIN: ${{ secrets.COOLDOWN_MIN }}
          ORB_BUFFER_BP: ${{ secrets.ORB_BUFFER_BP }}
          MAX_TOKENS: ${{ secrets.MAX_TOKENS }}

          # 可选：非交易时段测试才用（在 Secrets 里建 FORCE_RUN=1）
          FORCE_RUN: ${{ secrets.FORCE_RUN }}
        run: |
          # 错开分钟边界，避免数据源上一根bar还没落地
          sleep 15
          python -u intraday_watch_5m.py

      - name: Show state file (debug)
        if: always()
        run: |
          echo "===== intraday_state.json ====="
          cat intraday_state.json || true
