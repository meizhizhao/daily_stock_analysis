name: intraday-5m-monitor

# 关键：用引号避免 PyYAML 把 on 解析成 True (YAML 1.1)
"on":
  workflow_dispatch: {}

  # GitHub cron is UTC
  # 北京时间(UTC+8) A股: 09:30-11:30 / 13:00-15:00
  # 对应 UTC: 01:30-03:30 / 05:00-07:00
  schedule:
    # ======【测试用】每5分钟跑一次（仅工作日），验证 schedule 是否触发；验证通过后删除 ======
    - cron: "*/5 * * * 1-5"

    # ======【正式】交易时段 ======
    # 09:30-09:59 BJ (01:30-01:59 UTC) —— 固定分钟列表
    - cron: "30,35,40,45,50,55 1 * * 1-5"

    # 10:00-11:59 BJ (02:00-03:59 UTC) —— 每5分钟
    - cron: "*/5 2-3 * * 1-5"

    # 13:00-14:59 BJ (05:00-06:59 UTC) —— 每5分钟
    - cron: "*/5 5-6 * * 1-5"

    # 15:00 BJ (07:00 UTC) —— 收盘补一跑（可选）
    - cron: "0 7 * * 1-5"

permissions:
  contents: read

concurrency:
  group: intraday-5m-monitor
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    env:
      # ====== Secrets（必须配置）======
      FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
      OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}

      # ====== Variables（建议配置）======
      STOCK_LIST: ${{ vars.STOCK_LIST }}
      INDEX_LIST: ${{ vars.INDEX_LIST }}
      COOLDOWN_MIN: ${{ vars.COOLDOWN_MIN }}
      ORB_BUFFER_BP: ${{ vars.ORB_BUFFER_BP }}
      MAX_TOKENS: ${{ vars.MAX_TOKENS }}
      SYM_LLM_COOLDOWN_MIN: ${{ vars.SYM_LLM_COOLDOWN_MIN }}

      # 你要的快照冷却=2（脚本支持则生效；不支持也不影响）
      SNAPSHOT_COOLDOWN_MIN: "2"

      # 错开分钟边界：避免上一根bar还没落地
      JITTER_SEC: "15"

      # 手动调试才改 1；schedule 必须保持 0
      FORCE_RUN: "0"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyyaml

      # ---- 测试1：workflow YAML 自检（修复 on/True 坑）----
      - name: Test - parse workflow yaml
        run: |
          python - <<'PY'
          import yaml, pathlib
          p = pathlib.Path(".github/workflows/intraday_5m.yml")
          data = yaml.safe_load(p.read_text(encoding="utf-8"))
          assert isinstance(data, dict), "workflow yaml should parse to dict"

          # PyYAML(YAML 1.1) 可能把 on 解析成 True；两者都算通过
          ok = ("on" in data) or (True in data) or ("\"on\"" in data)
          assert ok, f"missing 'on' block (keys={list(data.keys())})"

          print("YAML parse OK. keys=", list(data.keys()))
          PY

      # ---- 测试2：打印触发器 & 时间（UTC/BJ）----
      - name: Test - debug trigger & time
        run: |
          echo "event=${{ github.event_name }}"
          echo "ref=${{ github.ref }}"
          echo "sha=${{ github.sha }}"
          echo "UTC time:"
          date -u "+%F %T"
          echo "BJ time:"
          TZ=Asia/Shanghai date "+%F %T"

      # ---- 测试3：Secrets/Variables 是否齐全（不打印敏感值）----
      - name: Test - check required env
        run: |
          set -e
          missing=0
          check() {
            name="$1"
            val="${!name}"
            if [ -z "$val" ]; then
              echo "::error::Missing env: $name"
              missing=1
            else
              echo "OK: $name"
            fi
          }

          check FEISHU_WEBHOOK_URL
          check OPENAI_BASE_URL
          check OPENAI_API_KEY
          check OPENAI_MODEL

          check STOCK_LIST
          check INDEX_LIST
          check COOLDOWN_MIN
          check ORB_BUFFER_BP
          check MAX_TOKENS
          check SYM_LLM_COOLDOWN_MIN

          if [ "$missing" -eq 1 ]; then
            exit 1
          fi

      # ---- 心跳：确认 schedule 确实启动（不依赖脚本是否产出事件）----
      - name: Heartbeat to Feishu
        if: always()
        env:
          WEBHOOK: ${{ secrets.FEISHU_WEBHOOK_URL }}
        run: |
          utc="$(date -u '+%F %T')"
          bj="$(TZ=Asia/Shanghai date '+%F %T')"
          payload='{"msg_type":"text","content":{"text":"【HEARTBEAT】intraday-5m-monitor started | event=${{ github.event_name }} | UTC='"$utc"' | BJ='"$bj"' | branch=${{ github.ref_name }}"}}'
          curl -sS -X POST -H "Content-Type: application/json" -d "$payload" "$WEBHOOK" >/dev/null || true

      - name: Jitter before run
        run: |
          echo "sleep ${JITTER_SEC}s ..."
          sleep "${JITTER_SEC}"

      - name: Run intraday watcher
        run: |
          python intraday_watch_5m.py

      # ---- 失败时：打印上下文 + 推送错误摘要 ----
      - name: Failure - print state & logs
        if: failure()
        run: |
          echo "=== ls -la ==="
          ls -la
          echo "=== intraday_state.json (if exists) ==="
          test -f intraday_state.json && cat intraday_state.json || echo "no intraday_state.json"

      - name: Failure - notify Feishu
        if: failure()
        env:
          WEBHOOK: ${{ secrets.FEISHU_WEBHOOK_URL }}
        run: |
          utc="$(date -u '+%F %T')"
          bj="$(TZ=Asia/Shanghai date '+%F %T')"
          payload='{"msg_type":"text","content":{"text":"【FAIL】intraday-5m-monitor failed | event=${{ github.event_name }} | UTC='"$utc"' | BJ='"$bj"' | run=${{ github.run_id }} | 查看 Actions 日志定位原因"}}'
          curl -sS -X POST -H "Content-Type: application/json" -d "$payload" "$WEBHOOK" >/dev/null || true
